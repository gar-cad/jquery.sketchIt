function SketchIt(e,n){this.canvas;this.ctx;this.penDown;this.mode;this.clicks;this.maxClicks;this.history;this.$me=$(e);this.settings=n;this.parentOffset;this.init();t=this;this.$me.on("vmousedown",function(){if(t.mode!="arrow"){t.penDown=true;t.clicks++;t.maxClicks++;t.draw({mode:"start",x:t.getRelativeCoords(event.pageX,"x"),y:t.getRelativeCoords(event.pageY,"y"),clickId:t.clicks},true)}}).on("vmousemove",function(){if(t.penDown&&t.mode!="arrow"){t.draw({mode:t.mode,x:t.getRelativeCoords(event.pageX,"x"),y:t.getRelativeCoords(event.pageY,"y")},true)}}).on("vmouseup",function(){if(t.penDown&&t.mode!="arrow"){t.draw({mode:t.mode,x:t.getRelativeCoords(event.pageX,"x"),y:t.getRelativeCoords(event.pageY,"y")},true);t.penDown=false}});if(n.tools){ref=["color","width","cap","tool"];$("body").on("click",'[data-control="#'+this.$me.attr("id")+'"]',function(e){for(i=0;i<ref.length;i++){$data=$(this).attr("data-"+ref[i]);if($data){t.changeSetting(ref[i],$data)}}$data=$(this).attr("data-options");if($data){switch($data){case"clear":t.clearCanvas();t.history=[];break;case"undo":t.undo();break;case"redo":t.redo()}}})}}SketchIt.prototype={init:function(){this.$me.append('<canvas class="sketchIt" style="cursor:crosshair;" width="'+this.$me.width()+'" height="'+this.$me.height()+'"></canvas>');this.parentOffset=this.$me.offset();this.canvas=this.$me.find(".sketchIt")[0];this.ctx=this.canvas.getContext("2d");this.penDown=false;this.clicks=0;this.maxClicks=this.clicks;this.history=[];this.changeSetting("color",this.settings.color);this.changeSetting("width",this.settings.width);this.changeSetting("cap",this.settings.cap);this.changeSetting("tool",this.settings.mode)},changeSetting:function(e,t){if(this.settings.tools){$("[data-"+e+"]").removeClass("current");$("[data-"+e+'="'+t+'"]').addClass("current");$('[data-category="'+e+'"] .catview').remove();$('[data-category="'+e+'"]').prepend('<span class="catview">'+$("[data-"+e+'="'+t+'"]').html()+"</span>")}log={mode:"set",key:e,val:t};this.set(log,true)},set:function(e,t){switch(e.key){case"color":this.ctx.strokeStyle=e.val;break;case"width":this.ctx.lineWidth=e.val;break;case"cap":this.ctx.lineCap=e.val;this.ctx.lineJoin=e.val;break;case"fill":this.ctx.fillStyle=e.val;break;case"tool":cursor=e.val=="arrow"?"auto":"crosshair";this.$me.find(".sketchIt").css("cursor",cursor);this.mode=e.val;break}if(t){this.history.push(e)}},draw:function(e,t){if(e.mode=="eraser"){this.ctx.globalCompositeOperation="destination-out"}else{this.ctx.globalCompositeOperation="source-over"}switch(e.mode){case"pen":case"eraser":this.ctx.lineTo(e.x,e.y);this.ctx.stroke();break;case"start":this.ctx.beginPath();this.ctx.moveTo(e.x,e.y);break}if(t){this.history.push(e)}},undo:function(){this.clicks--;this.redrawHistoryToPos()},redo:function(){if(this.clicks<this.maxClicks){this.clicks++}this.redrawHistoryToPos()},redrawHistoryToPos:function(){this.clearCanvas(false);for(i=0;i<this.history.length;i++){log=this.history[i];if(log.clickId>this.clicks){break}else{log.mode=="set"?this.set(log,false):this.draw(log,false)}}},clearCanvas:function(e){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.ctx.restore();if(e){this.history.push({mode:"clear"})}},getRelativeCoords:function(e,t){return t=="x"?e-this.parentOffset.left:e-this.parentOffset.top}};(function(e,t,n,r){e.fn.sketchIt=function(t){var n=e.extend({color:"#000",width:5,cap:"round",mode:"pen",tools:false},t);return this.each(function(){new SketchIt(this,n)})}})(jQuery,window,document)